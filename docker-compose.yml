version: '3.8'

services:
  # API Gateway
  api-gateway:
    build:
      context: ./apps/api-gateway
      dockerfile: Dockerfile
    ports:
      - "4000:4000"
    environment:
      - PORT=4000
      - NODE_ENV=production
    depends_on:
      - auth-service
      - sessions-service
      - projects-service
      - equivalents-service
      - messaging-service
      - transactions-service
      - funds-service
      - payments-service
      - portfolio-service
      - reporting-service
    networks:
      - microservices

  # TypeScript/NestJS Services
  auth-service:
    build:
      context: ./services/ts/auth-service
      dockerfile: ../../Dockerfile.nestjs
    ports:
      - "4001:4001"
    environment:
      - PORT=4001
      - NODE_ENV=production
    networks:
      - microservices

  webhook-service:
    build:
      context: ./services/ts/webhook-service
      dockerfile: Dockerfile
    ports:
      - "3002:3002"
    environment:
      - PORT=3002
      - NODE_ENV=production
    networks:
      - microservices

  sessions-service:
    build:
      context: ./services/ts/sessions-service
      dockerfile: ../../Dockerfile.nestjs
    ports:
      - "4002:4002"
    environment:
      - PORT=4002
      - NODE_ENV=production
    networks:
      - microservices

  projects-service:
    build:
      context: ./services/ts/projects-service
      dockerfile: ../../Dockerfile.nestjs
    ports:
      - "4003:4003"
    environment:
      - PORT=4003
      - NODE_ENV=production
    networks:
      - microservices

  equivalents-service:
    build:
      context: ./services/ts/equivalents-service
      dockerfile: ../../Dockerfile.nestjs
    ports:
      - "3005:3005"
    environment:
      - PORT=3005
      - NODE_ENV=production
    networks:
      - microservices

  # Rust Services
  messaging-service:
    build:
      context: ./services/rust/messaging-service
      dockerfile: Dockerfile
    ports:
      - "4004:4004"
    environment:
      - PORT=4004
      - RUST_LOG=info
    networks:
      - microservices

  # Go Services
  transactions-service:
    build:
      context: ./services/go/transactions-service
      dockerfile: Dockerfile
    ports:
      - "4008:4008"
    environment:
      - PORT=4008
    networks:
      - microservices

  funds-service:
    build:
      context: ./services/go/funds-service
      dockerfile: Dockerfile
    ports:
      - "4009:4009"
    environment:
      - PORT=4009
    networks:
      - microservices

  payments-service:
    build:
      context: ./services/go/payments-service
      dockerfile: Dockerfile
    ports:
      - "3102:3102"
    environment:
      - PORT=3102
      - STRIPE_API_KEY=${STRIPE_API_KEY}
      - ADYEN_API_KEY=${ADYEN_API_KEY}
    networks:
      - microservices

  # .NET Services
  portfolio-service:
    build:
      context: ./services/cs/portfolio-service
      dockerfile: Dockerfile
    ports:
      - "4010:4010"
    environment:
      - PORT=4010
      - ASPNETCORE_ENVIRONMENT=Production
    networks:
      - microservices

  reporting-service:
    build:
      context: ./services/cs/reporting-service
      dockerfile: Dockerfile
    ports:
      - "4011:4011"
    environment:
      - PORT=4011
      - ASPNETCORE_ENVIRONMENT=Production
    networks:
      - microservices

networks:
  microservices:
    driver: bridge

