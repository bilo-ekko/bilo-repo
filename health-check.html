<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microservices Health Check Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Dark theme (default) */
            --bg-primary: #000000;
            --bg-secondary: rgba(255, 255, 255, 0.02);
            --bg-tertiary: rgba(255, 255, 255, 0.05);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.9);
            --text-tertiary: rgba(255, 255, 255, 0.7);
            --border-primary: rgba(255, 255, 255, 0.15);
            --border-hover: #14b8a6;
            --btn-secondary-bg: rgba(255, 255, 255, 0.2);
            --btn-secondary-hover: rgba(255, 255, 255, 0.3);
            --card-bg: #1a1a1a;
            --card-border: rgba(255, 255, 255, 0.1);
            --shadow: rgba(0, 0, 0, 0.3);
        }

        [data-theme="light"] {
            /* Light theme */
            --bg-primary: #f9fafb;
            --bg-secondary: rgba(0, 0, 0, 0.02);
            --bg-tertiary: rgba(0, 0, 0, 0.05);
            --text-primary: #1f2937;
            --text-secondary: #374151;
            --text-tertiary: #6b7280;
            --border-primary: #e5e7eb;
            --border-hover: #059669;
            --btn-secondary-bg: rgba(0, 0, 0, 0.1);
            --btn-secondary-hover: rgba(0, 0, 0, 0.15);
            --card-bg: #ffffff;
            --card-border: #e5e7eb;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding-top: 80px;
            padding-left: 2rem;
            padding-right: 2rem;
            padding-bottom: 2rem;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            z-index: 1000;
            backdrop-filter: blur(10px);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .top-bar-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text-primary);
        }

        .top-bar-title h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }

        .top-bar-title i {
            font-size: 1.5rem;
        }

        .top-bar-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }


        h2 {
            font-size: 1.5rem;
            margin: 0;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .btn-icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 2px solid var(--border-primary);
            background: transparent;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            padding: 0;
        }

        .btn-icon:hover {
            background: var(--bg-tertiary);
            transform: scale(1.05);
        }

        .btn-icon.check-all {
            border-color: var(--border-primary);
        }

        .btn-icon.check-all:hover {
            border-color: var(--border-hover);
            color: var(--border-hover);
        }

        .btn-icon.auto-refresh {
            border-color: var(--border-primary);
        }

        .btn-icon.auto-refresh.active {
            border-color: #10b981;
            color: #10b981;
        }

        .btn-icon.auto-refresh:hover {
            border-color: var(--border-hover);
        }

        .btn-icon.auto-refresh.active:hover {
            border-color: #059669;
            color: #059669;
        }

        .btn-theme {
            background: transparent;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            border: 1px solid var(--border-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .btn-theme:hover {
            background: var(--bg-tertiary);
        }

        /* Accordion Styles */
        .accordion {
            background: transparent;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            border: 2px solid var(--border-primary);
            overflow: hidden;
            transition: border-color 0.3s ease;
        }

        .accordion:hover {
            border-color: var(--border-hover);
        }

        .accordion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            cursor: pointer;
            user-select: none;
            background: transparent;
            transition: background 0.2s;
        }

        .accordion-header:hover {
            background: var(--bg-tertiary);
        }

        .accordion-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text-primary);
        }

        .accordion-icon {
            font-size: 1.5rem;
        }

        .accordion-title h2 {
            color: var(--text-primary);
        }

        .accordion-summary {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            color: var(--text-primary);
        }

        .summary-stat {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .summary-stat .stat-icon {
            font-size: 1.25rem;
        }

        .chevron {
            font-size: 1.25rem;
            transition: transform 0.3s ease;
            margin-left: 0.5rem;
            color: var(--text-primary);
        }

        .accordion-header.collapsed .chevron {
            transform: rotate(-90deg);
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .accordion-content.expanded {
            max-height: 5000px;
            padding: 1.5rem;
            background: var(--bg-secondary);
        }

        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stat-icon {
            font-size: 1.5rem;
        }

        /* Card styles that will be used in the web component */
    </style>
</head>

<body>
    <div class="top-bar">
        <div class="top-bar-title">
            <i class="fa-solid fa-heartbeat"></i>
            <h1>Service Health Dashboard</h1>
        </div>
        <div class="top-bar-actions">
            <button class="btn-icon check-all" onclick="checkAllItems()" title="Check All Services">
                <i class="fa-solid fa-rotate"></i>
            </button>
            <button class="btn-icon auto-refresh" onclick="toggleAutoRefresh()" id="autoRefreshBtn" title="Toggle Auto-refresh">
                <i class="fa-solid fa-circle-play" id="autoRefreshIcon"></i>
            </button>
            <button class="btn-theme" onclick="toggleTheme()" id="themeToggle" title="Toggle theme">
                <i class="fa-solid fa-moon" id="themeIcon"></i>
                <span id="themeText">Dark</span>
            </button>
        </div>
    </div>

    <div class="container">

        <!-- Web Applications Accordion -->
        <div class="accordion" style="margin-top: 1rem;">
            <div class="accordion-header" id="webappsHeader" onclick="toggleAccordion('webapps')">
                <div class="accordion-title">
                    <span class="accordion-icon"><i class="fa-solid fa-globe"></i></span>
                    <h2>Web Applications</h2>
                </div>
                <div class="accordion-summary">
                    <div class="summary-stat">
                        <span class="stat-icon" style="color: #10b981;"><i class="fa-regular fa-circle-check"></i></span>
                        <span id="webappsHealthyCount">-</span>
                    </div>
                    <div class="summary-stat">
                        <span class="stat-icon" style="color: #f59e0b;"><i class="fa-regular fa-triangle-exclamation"></i></span>
                        <span id="webappsSlowCount">-</span>
                    </div>
                    <div class="summary-stat">
                        <span class="stat-icon" style="color: #ef4444;"><i class="fa-regular fa-circle-xmark"></i></span>
                        <span id="webappsDownCount">-</span>
                    </div>
                    <span class="chevron"><i class="fa-solid fa-chevron-right"></i></span>
                </div>
            </div>
            <div class="accordion-content expanded" id="webappsContent">
                <div id="webappsGrid" class="services-grid"></div>
            </div>
        </div>

        <!-- Backend Services Accordion -->
        <div class="accordion">
            <div class="accordion-header" id="servicesHeader" onclick="toggleAccordion('services')">
                <div class="accordion-title">
                    <span class="accordion-icon"><i class="fa-solid fa-gears"></i></span>
                    <h2>Backend Services</h2>
                </div>
                <div class="accordion-summary">
                    <div class="summary-stat">
                        <span class="stat-icon" style="color: #10b981;"><i class="fa-regular fa-circle-check"></i></span>
                        <span id="servicesHealthyCount">-</span>
                    </div>
                    <div class="summary-stat">
                        <span class="stat-icon" style="color: #f59e0b;"><i class="fa-regular fa-triangle-exclamation"></i></span>
                        <span id="servicesSlowCount">-</span>
                    </div>
                    <div class="summary-stat">
                        <span class="stat-icon" style="color: #ef4444;"><i class="fa-regular fa-circle-xmark"></i></span>
                        <span id="servicesDownCount">-</span>
                    </div>
                    <span class="chevron"><i class="fa-solid fa-chevron-right"></i></span>
                </div>
            </div>
            <div class="accordion-content expanded" id="servicesContent">
                <div id="servicesGrid" class="services-grid"></div>
            </div>
        </div>
    </div>

    <script>
        // Web Component for service status cards
        class ServiceStatusCard extends HTMLElement {
            constructor() {
                super();
                this.attachShadow({ mode: 'open' });
                this.isExpanded = false;
            }

            static get observedAttributes() {
                return ['name', 'port', 'status', 'response-time', 'language', 'features', 'framework'];
            }

            attributeChangedCallback() {
                this.render();
            }

            getLanguageTag(language) {
                const languageMap = {
                    'TypeScript (NestJS)': { class: 'lang-ts', text: 'TypeScript' },
                    'Python (FastAPI)': { class: 'lang-python', text: 'Python' },
                    'Go (Fiber)': { class: 'lang-go', text: 'Go' },
                    'Go': { class: 'lang-go', text: 'Go' },
                    'Rust': { class: 'lang-rust', text: 'Rust' },
                    'C# (.NET Core)': { class: 'lang-csharp', text: 'C#' },
                };
                return languageMap[language] || { class: 'lang-other', text: language };
            }

            getFrameworkLogo(framework) {
                const logoMap = {
                    'Next.js': 'https://raw.githubusercontent.com/devicons/devicon/master/icons/nextjs/nextjs-original.svg',
                    'Svelte': 'https://raw.githubusercontent.com/devicons/devicon/master/icons/svelte/svelte-original.svg',
                    'Vue.js': 'https://raw.githubusercontent.com/devicons/devicon/master/icons/vuejs/vuejs-original.svg',
                };
                return logoMap[framework];
            }

            getFrameworkUrl(framework) {
                const urlMap = {
                    'Next.js': 'https://nextjs.org/',
                    'Svelte': 'https://svelte.dev/',
                    'Vue.js': 'https://vuejs.org/',
                };
                return urlMap[framework];
            }

            getLanguageUrl(language) {
                const urlMap = {
                    'TypeScript (NestJS)': 'https://nestjs.com/',
                    'Python (FastAPI)': 'https://fastapi.tiangolo.com/',
                    'Go (Fiber)': 'https://gofiber.io/',
                    'Go': 'https://go.dev/',
                    'Rust': 'https://actix.rs/',
                    'C# (.NET Core)': 'https://dotnet.microsoft.com/',
                };
                return urlMap[language];
            }

            render() {
                const name = this.getAttribute('name');
                const port = this.getAttribute('port');
                const status = this.getAttribute('status');
                const responseTime = this.getAttribute('response-time');
                const language = this.getAttribute('language');
                const framework = this.getAttribute('framework');
                const url = this.getAttribute('url') || `http://localhost:${port}`;
                const featuresAttr = this.getAttribute('features');
                const features = featuresAttr ? JSON.parse(featuresAttr) : [];

                const languageTag = this.getLanguageTag(language);
                const frameworkLogo = framework ? this.getFrameworkLogo(framework) : null;
                const frameworkUrl = framework ? this.getFrameworkUrl(framework) : null;
                const languageUrl = language ? this.getLanguageUrl(language) : null;

                // Calculate stats from response time data
                const chartData = getResponseTimeData(name);
                const stats = calculateStats(chartData);

                // Get status info using utility functions
                let statusClass = 'status-checking';
                let statusText = 'Checking...';
                let statusIcon = getStatusIcon(status || 'checking');
                let statusIndicatorIcon = '<i class="fa-solid fa-spinner fa-spin"></i>';

                if (status === 'healthy') {
                    statusClass = 'status-healthy';
                    statusText = 'Healthy';
                    statusIndicatorIcon = '<i class="fa-solid fa-circle-check"></i>';
                } else if (status === 'slow') {
                    statusClass = 'status-slow';
                    statusText = 'Slow';
                    statusIndicatorIcon = '<i class="fa-solid fa-triangle-exclamation"></i>';
                } else if (status === 'down') {
                    statusClass = 'status-down';
                    statusText = 'Down';
                    statusIndicatorIcon = '<i class="fa-solid fa-circle-xmark"></i>';
                }

                let featuresHTML = '';
                if (features.length > 0) {
                    featuresHTML = `
                        <div class="features-section">
                            <button class="features-toggle" id="featuresToggle">
                                <span>Features (${features.length})</span>
                                <span class="feature-chevron"><i class="fa-solid fa-chevron-right"></i></span>
                            </button>
                            <div class="features-content" id="featuresContent">
                                <ul class="features-list">
                                    ${features.map(f => `<li>${f}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                }

                this.shadowRoot.innerHTML = `
                    <style>
                        * {
                            box-sizing: border-box;
                        }

                        .card {
                            background: var(--card-bg, #ffffff);
                            border-radius: 12px;
                            box-shadow: 0 4px 6px var(--shadow, rgba(0, 0, 0, 0.1));
                            border: 1px solid var(--card-border, #e5e7eb);
                            overflow: hidden;
                            transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s ease, border-color 0.3s ease;
                        }

                        .card:hover {
                            transform: translateY(-4px);
                            box-shadow: 0 8px 16px var(--shadow, rgba(0, 0, 0, 0.15));
                        }

                        .card-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: flex-start;
                            padding: 1.5rem;
                            border-bottom: 2px solid var(--card-border);
                        }

                        .service-info {
                            flex: 1;
                        }

                        .service-name {
                            font-size: 1.25rem;
                            font-weight: 700;
                            color: var(--text-primary);
                            margin-bottom: 0.5rem;
                            display: flex;
                            align-items: center;
                            gap: 0.75rem;
                        }

                        .service-name a {
                            color: var(--text-primary);
                            text-decoration: none;
                            transition: color 0.2s;
                        }

                        .service-name a:hover {
                            color: var(--border-hover);
                        }

                        .framework-logo {
                            width: 24px;
                            height: 24px;
                            background: var(--card-bg);
                            border-radius: 4px;
                            padding: 2px;
                            cursor: pointer;
                            transition: transform 0.2s;
                        }

                        .framework-logo:hover {
                            transform: scale(1.1);
                        }

                        .language-link {
                            display: inline-block;
                            transition: transform 0.2s;
                        }

                        .language-link:hover {
                            transform: scale(1.05);
                        }

                        .service-meta {
                            display: flex;
                            gap: 0.75rem;
                            font-size: 0.875rem;
                            color: var(--text-tertiary, #6b7280);
                            flex-wrap: wrap;
                        }

                        .status-indicator {
                            width: 24px;
                            height: 24px;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 0.875rem;
                        }

                        .status-healthy .status-indicator {
                            color: #10b981;
                        }

                        .status-slow .status-indicator {
                            color: #f59e0b;
                        }

                        .status-down .status-indicator {
                            color: #ef4444;
                        }

                        .status-checking .status-indicator {
                            color: #6b7280;
                        }

                        .status-checking .status-indicator i {
                            animation: pulse 2s infinite;
                        }

                        .card-body {
                            padding: 1.5rem;
                            display: grid;
                            grid-template-columns: repeat(2, 1fr);
                            gap: 1rem;
                        }

                        .metric {
                            display: flex;
                            flex-direction: column;
                            gap: 0.25rem;
                        }

                        .metric-label {
                            font-size: 0.875rem;
                            color: var(--text-tertiary);
                            font-weight: 500;
                        }

                        .metric-value {
                            font-size: 1.125rem;
                            font-weight: 700;
                            color: var(--text-primary);
                        }

                        .status-badge {
                            display: inline-flex;
                            align-items: center;
                            gap: 0.5rem;
                            padding: 0.375rem 0.75rem;
                            border-radius: 6px;
                            font-size: 0.875rem;
                            font-weight: 600;
                        }

                        .status-healthy .status-badge {
                            background: #d1fae5;
                            color: #065f46;
                        }

                        .status-healthy .status-badge i {
                            color: #10b981;
                        }

                        .status-slow .status-badge {
                            background: #fef3c7;
                            color: #92400e;
                        }

                        .status-slow .status-badge i {
                            color: #f59e0b;
                        }

                        .status-down .status-badge {
                            background: #fee2e2;
                            color: #991b1b;
                        }

                        .status-down .status-badge i {
                            color: #ef4444;
                        }

                        .status-checking .status-badge {
                            background: var(--bg-tertiary);
                            color: var(--text-tertiary);
                        }

                        .status-checking .status-badge i {
                            color: var(--text-tertiary);
                        }

                        .features-section {
                            padding: 0 1.5rem 1.5rem;
                        }

                        .features-toggle {
                            width: 100%;
                            padding: 0.75rem;
                            background: var(--bg-secondary, #f9fafb);
                            border: 1px solid var(--card-border, #e5e7eb);
                            border-radius: 8px;
                            cursor: pointer;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            font-weight: 600;
                            color: var(--text-primary, #374151);
                            transition: background 0.2s;
                        }

                        .features-toggle:hover {
                            background: var(--bg-tertiary, #f3f4f6);
                        }

                        .feature-chevron {
                            transition: transform 0.2s;
                            font-size: 1rem;
                        }

                        .feature-chevron.expanded {
                            transform: rotate(90deg);
                        }

                        .features-content {
                            max-height: 0;
                            overflow: hidden;
                            transition: max-height 0.3s ease;
                        }

                        .features-content.expanded {
                            max-height: 500px;
                            margin-top: 0.75rem;
                        }

                        .features-list {
                            list-style: none;
                            padding: 0;
                            margin: 0;
                        }

                        .features-list li {
                            padding: 0.5rem 0.75rem;
                            background: var(--bg-secondary, #ffffff);
                            border-left: 3px solid #8b5cf6;
                            margin-bottom: 0.5rem;
                            border-radius: 0 4px 4px 0;
                            font-size: 0.875rem;
                            color: var(--text-secondary, #4b5563);
                        }

                        .language-tag {
                            font-size: 0.75rem;
                            padding: 0.25rem 0.5rem;
                            border-radius: 4px;
                            font-weight: 600;
                        }

                        .lang-ts {
                            background: #3178c6;
                            color: white;
                        }

                        .lang-python {
                            background: #3776ab;
                            color: white;
                        }

                        .lang-go {
                            background: #00add8;
                            color: white;
                        }

                        .lang-rust {
                            background: #ce422b;
                            color: white;
                        }

                        .lang-csharp {
                            background: #239120;
                            color: white;
                        }

                        .lang-other {
                            background: #6b7280;
                            color: white;
                        }

                        .chart-container {
                            margin-top: 12px;
                            padding: 8px;
                            background: var(--bg-secondary);
                            border-radius: 6px;
                            border: 1px solid var(--border-primary);
                        }

                        .chart-container canvas {
                            width: 100%;
                            height: 60px;
                            border-radius: 4px;
                        }

                        @keyframes pulse {
                            0%, 100% {
                                opacity: 1;
                            }
                            50% {
                                opacity: 0.5;
                            }
                        }
                    </style>

                    <div class="card ${statusClass}">
                        <div class="card-header">
                            <div class="service-info">
                                <div class="service-name">
                                    ${frameworkLogo ? `<a href="${frameworkUrl}" target="_blank" rel="noopener noreferrer"><img src="${frameworkLogo}" alt="${framework}" class="framework-logo" /></a>` : ''}
                                    <a href="${url}" target="_blank" rel="noopener noreferrer">${name}</a>
                                </div>
                                <div class="service-meta">
                                    <span>Port ${port}</span>
                                    ${framework ? `<a href="${frameworkUrl}" target="_blank" rel="noopener noreferrer" class="language-link"><span class="language-tag" style="background: #8b5cf6; color: white;">${framework}</span></a>` : ''}
                                    ${!framework && language && languageUrl ? `<a href="${languageUrl}" target="_blank" rel="noopener noreferrer" class="language-link"><span class="language-tag ${languageTag.class}">${languageTag.text}</span></a>` : ''}
                                    ${!framework && language && !languageUrl ? `<span class="language-tag ${languageTag.class}">${languageTag.text}</span>` : ''}
                                </div>
                            </div>
                            <div class="status-indicator">${statusIndicatorIcon}</div>
                        </div>
                        <div class="card-body" style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <div style="display: flex; flex-direction: row; gap: 0.5rem; justify-content: space-between;">
                                <div class="metric">
                                    <div class="metric-label">Status</div>
                                    <div class="status-badge">
                                        ${statusIcon}
                                        ${statusText}
                                    </div>
                                </div>
                                <div class="metric">
                                    <div class="metric-label">Response</div>
                                    <div class="metric-value">${responseTime}</div>
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: row; gap: 0.5rem; justify-content: space-between;">
                                <div class="metric">
                                    <div class="metric-label">
                                        <i class="fa-solid fa-arrow-down"></i> 
                                        Min</div>
                                    <div class="metric-value">${stats.min}ms</div>
                                </div>
                                <div class="metric">
                                    <div class="metric-label"><i class="fa-solid fa-chart-line"></i> Avg</div>
                                    <div class="metric-value">${stats.avg}ms</div>
                                </div>
                                <div class="metric">
                                    <div class="metric-label"><i class="fa-solid fa-arrow-up"></i> Max</div>
                                    <div class="metric-value">${stats.max}ms</div>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="chart-${port}"></canvas>
                            </div>
                        </div>
                        ${featuresHTML}
                    </div>
                `;

                // Add toggle functionality if features exist
                if (features.length > 0) {
                    const toggleBtn = this.shadowRoot.getElementById('featuresToggle');
                    const content = this.shadowRoot.getElementById('featuresContent');
                    const chevron = toggleBtn.querySelector('.feature-chevron');
                    
                    toggleBtn.addEventListener('click', () => {
                        this.isExpanded = !this.isExpanded;
                        
                        if (this.isExpanded) {
                            content.classList.add('expanded');
                            chevron.classList.add('expanded');
                        } else {
                            content.classList.remove('expanded');
                            chevron.classList.remove('expanded');
                        }
                    });
                }

                // Render response time chart
                setTimeout(() => {
                    const chartData = getResponseTimeData(name);
                    const canvas = this.shadowRoot.getElementById(`chart-${port}`);
                    const currentStatus = status || 'checking';
                    if (canvas) {
                        renderResponseTimeChartOnCanvas(canvas, chartData, name, currentStatus);
                    } else {
                        console.log(`Canvas not found in shadow DOM: chart-${port}`);
                    }
                }, 100); // Small delay to ensure canvas is rendered
            }
        }

        // Register the web component
        customElements.define('service-status-card', ServiceStatusCard);

        // Data collection configuration
        const REFRESH_INTERVAL = 500;
        const DATA_POINTS = 100;
        let responseTimeData = {}; // Store response time data for each service
        let isAutoRefreshActive = false;

        // Web applications configuration
        const webapps = [
            {
                name: 'Web',
                port: 9001,
                framework: 'Next.js',
                endpoint: 'http://localhost:9001',
                url: 'http://localhost:9001',
                features: [
                    'Main web application',
                    'React 19',
                    'App Router',
                    'Shared UI components'
                ]
            },
            {
                name: 'Dashboard',
                port: 9003,
                framework: 'Next.js',
                endpoint: 'http://localhost:9003',
                url: 'http://localhost:9003',
                features: [
                    'Admin dashboard',
                    'Real-time metrics',
                    'Service monitoring'
                ]
            },
            {
                name: 'Checkout',
                port: 3006,
                framework: 'Svelte',
                endpoint: 'http://localhost:3006',
                url: 'http://localhost:3006',
                features: [
                    'Checkout experience',
                    'SvelteKit',
                    'Fast performance'
                ]
            },
            {
                name: 'Post-Purchase',
                port: 3007,
                framework: 'Vue.js',
                endpoint: 'http://localhost:3007',
                url: 'http://localhost:3007',
                features: [
                    'Post-purchase portal',
                    'Vue 3',
                    'Vite'
                ]
            },
        ];

        // Service configuration
        const services = [
            {
                name: 'API Gateway',
                port: 4000,
                language: 'TypeScript (NestJS)',
                endpoint: 'http://localhost:4000/health',
                url: 'http://localhost:4000',
                features: [
                    'Service Discovery',
                    'Request routing',
                    'Load balancing'
                ]
            },
            {
                name: 'Auth Service',
                port: 4001,
                language: 'TypeScript (NestJS)',
                endpoint: 'http://localhost:4001/health',
                url: 'http://localhost:4001',
                features: [
                    'AuthN/Z',
                    'JWT/OAuth2',
                    'API keys',
                    'User/Org models',
                ]
            },
            {
                name: 'Sessions Service',
                port: 4002,
                language: 'TypeScript (NestJS)',
                endpoint: 'http://localhost:4002/health',
                url: 'http://localhost:4002',
                features: [
                    'ImpactPay sessions',
                    'Checkout sessions',
                ]
            },
            {
                name: 'Projects Service',
                port: 4003,
                language: 'TypeScript (NestJS)',
                endpoint: 'http://localhost:4003/health',
                url: 'http://localhost:4003',
                features: [
                    'Project metadata',
                    'Project assets & images'
                ]
            },
            {
                name: 'Messaging Service',
                port: 4004,
                language: 'Rust',
                endpoint: 'http://localhost:4004/health',
                url: 'http://localhost:4004',
                features: [
                    'Emails',
                    'Notifications',
                    'SMS'
                ]
            },
            {
                name: 'Users Service',
                port: 4007,
                language: 'Rust',
                endpoint: 'http://localhost:4007/health',
                url: 'http://localhost:4007',
                features: [
                    'User management',
                    'User CRUD operations',
                    'User authentication support'
                ]
            },
            {
                name: 'Calculator Service',
                port: 4005,
                language: 'Python (FastAPI)',
                endpoint: 'http://localhost:4005/health',
                url: 'http://localhost:4005/docs',
                features: [
                    'Carbon emission calculations',
                    'Activity-based CO2 tracking',
                    'Emission factors database'
                ]
            },
            {
                name: 'Analytics Service',
                port: 4006,
                language: 'Python (FastAPI)',
                endpoint: 'http://localhost:4006/health',
                url: 'http://localhost:4006/docs',
                features: [
                    'Metrics tracking',
                    'Event tracking',
                    'Data aggregation',
                    'Dashboard statistics'
                ]
            },
            {
                name: 'Transactions Service',
                port: 4008,
                language: 'Go (Fiber)',
                endpoint: 'http://localhost:4008/health',
                url: 'http://localhost:4008',
                features: [
                    'All money movement records',
                ]
            },
            {
                name: 'Funds Service',
                port: 4009,
                language: 'Go',
                endpoint: 'http://localhost:4009/health',
                url: 'http://localhost:4009',
                features: [
                    'Funds ledger',
                    'Reconciliation',
                    'Concurrent operations',
                ]

            },
            {
                name: 'Portfolio Service',
                port: 4010,
                language: 'C# (.NET Core)',
                endpoint: 'http://localhost:4010/health',
                url: 'http://localhost:4010',
                features: [
                    'Portfolio aggregation',
                    'Reporting',
                    'Typed DTOs',
                ]
            },
            {
                name: 'Reporting Service',
                port: 4011,
                language: 'C# (.NET Core)',
                endpoint: 'http://localhost:4011/health',
                url: 'http://localhost:4011',
                features: [
                    'Heavy reporting',
                    'Aggregates',
                    'Data pipelines',
                ]
            },
        ];

        let autoRefreshInterval = null;

        // Helper function to get service folder name from service name
        function getServiceFolderName(serviceName) {
            const folderMap = {
                'API Gateway': 'api-gateway',
                'Auth Service': 'auth-service',
                'Sessions Service': 'sessions-service',
                'Projects Service': 'projects-service',
                'Messaging Service': 'messaging-service',
                'Users Service': 'users-service',
                'Calculator Service': 'calculator-service',
                'Analytics Service': 'analytics-service',
                'Transactions Service': 'transactions-service',
                'Funds Service': 'funds-service',
                'Portfolio Service': 'portfolio-service',
                'Reporting Service': 'reporting-service',
                'Web': 'web',
                'Docs': 'docs',
                'Dashboard': 'web-dashboard',
                'Checkout': 'web-checkout',
                'Post-Purchase': 'web-postpurchase'
            };
            return folderMap[serviceName] || serviceName.toLowerCase().replace(/\s+/g, '-');
        }

        // Initialize data arrays for all services
        function initializeDataArrays() {
            // Initialize for webapps
            webapps.forEach(webapp => {
                const folderName = getServiceFolderName(webapp.name);
                responseTimeData[folderName] = new Array(DATA_POINTS).fill(0);
            });
            
            // Initialize for services
            services.forEach(service => {
                const folderName = getServiceFolderName(service.name);
                responseTimeData[folderName] = new Array(DATA_POINTS).fill(0);
            });
        }

        // Add new response time data point
        function addDataPoint(serviceName, responseTime) {
            if (!isAutoRefreshActive) return;
            
            const folderName = getServiceFolderName(serviceName);
            if (responseTimeData[folderName]) {
                // Remove first element and add new one at the end
                responseTimeData[folderName].shift();
                responseTimeData[folderName].push(responseTime);
            }
        }

        // Get response time data for a specific service (for debugging/charting)
        function getResponseTimeData(serviceName) {
            const folderName = getServiceFolderName(serviceName);
            return responseTimeData[folderName] || [];
        }

        // Calculate statistics from response time data
        function calculateStats(data) {
            if (!data || data.length === 0) {
                return { min: 0, max: 0, avg: 0 };
            }
            
            // Filter out zero values (no data points)
            const validData = data.filter(val => val > 0);
            
            if (validData.length === 0) {
                return { min: 0, max: 0, avg: 0 };
            }
            
            const min = Math.min(...validData);
            const max = Math.max(...validData);
            const avg = Math.round(validData.reduce((sum, val) => sum + val, 0) / validData.length);
            
            return { min, max, avg };
        }

        // Get all response time data (for debugging)
        function getAllResponseTimeData() {
            return responseTimeData;
        }

        // Get status color utility function
        function getStatusColor(status) {
            switch(status) {
                case 'healthy':
                    return '#10b981'; // green
                case 'slow':
                    return '#f59e0b'; // orange/yellow
                case 'down':
                    return '#ef4444'; // red
                case 'checking':
                default:
                    return '#6b7280'; // gray
            }
        }

        // Get status icon utility function (matches accordion style)
        function getStatusIcon(status) {
            switch(status) {
                case 'healthy':
                    return '<i class="fa-regular fa-circle-check"></i>';
                case 'slow':
                    return '<i class="fa-regular fa-triangle-exclamation"></i>';
                case 'down':
                    return '<i class="fa-regular fa-circle-xmark"></i>';
                case 'checking':
                default:
                    return '<i class="fa-solid fa-spinner fa-spin"></i>';
            }
        }

        // Render line chart for response time data (by canvas element)
        function renderResponseTimeChartOnCanvas(canvas, data, serviceName, status = 'checking') {
            if (!canvas) {
                console.log(`Canvas element is null for ${serviceName}`);
                return;
            }
            
            // Set canvas dimensions to match its displayed size
            const container = canvas.parentElement;
            const containerWidth = container ? container.clientWidth - 16 : 400; // Subtract padding
            canvas.width = containerWidth;
            canvas.height = 60;
        
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // Get status color for chart
            const chartColor = getStatusColor(status);
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            // If no data or all zeros, show empty chart
            if (!data || data.length === 0 || data.every(val => val === 0)) {
                ctx.fillStyle = '#666';
                ctx.font = '12px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('No data', width / 2, height / 2);
                console.log(`No data for ${serviceName}, showing empty chart`);
                return;
            }
            
            // Find min and max values for scaling
            const maxValue = Math.max(...data);
            const minValue = Math.min(...data);
            const range = maxValue - minValue || 1; // Avoid division by zero
            
            // Chart dimensions
            const padding = 8;
            const chartWidth = width - (padding * 2);
            const chartHeight = height - (padding * 2);
            
            // Draw line chart
            ctx.strokeStyle = chartColor;
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            data.forEach((value, index) => {
                const x = padding + (chartWidth / (data.length - 1)) * index;
                const y = height - padding - ((value - minValue) / range) * chartHeight;
                
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            
            ctx.stroke();
            
            // Draw data points
            ctx.fillStyle = chartColor;
            data.forEach((value, index) => {
                const x = padding + (chartWidth / (data.length - 1)) * index;
                const y = height - padding - ((value - minValue) / range) * chartHeight;
                
                ctx.beginPath();
                ctx.arc(x, y, 2, 0, 2 * Math.PI);
                ctx.fill();
            });
            
            // Draw value labels on the right
            if (maxValue > 0) {
                ctx.fillStyle = 'var(--text-secondary)';
                ctx.font = '10px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText(`${maxValue}ms`, width - 40, padding + 12);
                ctx.fillText(`${minValue}ms`, width - 40, height - padding);
            }
        }

        // Toggle accordion
        function toggleAccordion(section) {
            const header = document.getElementById(`${section}Header`);
            const content = document.getElementById(`${section}Content`);
            
            header.classList.toggle('collapsed');
            content.classList.toggle('expanded');
        }

        // Check individual item (webapp or service)
        async function checkItem(item) {
            const startTime = performance.now();

            try {
                // For services with /health endpoint, try CORS first
                // For webapps, use no-cors mode to avoid CORS issues
                const isHealthEndpoint = item.endpoint && item.endpoint.includes('/health');
                let response;
                
                if (isHealthEndpoint) {
                    // Try CORS mode for services with health endpoints
                    try {
                        response = await fetch(item.endpoint, {
                            method: 'GET',
                            mode: 'cors',
                            cache: 'no-cache',
                        });
                    } catch (corsError) {
                        // If CORS fails, try no-cors as fallback
                        response = await fetch(item.endpoint, {
                            method: 'GET',
                            mode: 'no-cors',
                            cache: 'no-cache',
                        });
                    }
                } else {
                    // For webapps, use no-cors mode
                    response = await fetch(item.endpoint, {
                        method: 'GET',
                        mode: 'no-cors',
                        cache: 'no-cache',
                    });
                }

                const endTime = performance.now();
                const responseTime = Math.round(endTime - startTime);

                // With no-cors mode, response.type is 'opaque' and response.ok might not be accurate
                // So we check response.type for opaque responses
                if (response.type === 'opaque' || response.ok) {
                    // Add data point for charting if auto-refresh is active
                    addDataPoint(item.name, responseTime);
                    
                    return {
                        status: responseTime > 1000 ? 'slow' : 'healthy',
                        responseTime: `${responseTime}ms`
                    };
                }

                // Add data point even for failed requests (0ms)
                addDataPoint(item.name, 0);
                return { status: 'down', responseTime: '-' };
            } catch (error) {
                // If fetch fails completely (network error), try image loading for webapps
                // This works even with CORS restrictions
                if (item.endpoint && !item.endpoint.includes('/health')) {
                    try {
                        const img = new Image();
                        const timeout = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('timeout')), 3000)
                        );
                        
                        await Promise.race([
                            new Promise((resolve) => {
                                // Even if image fails, if the server responded, we're good
                                img.onload = () => resolve(true);
                                img.onerror = () => {
                                    // Try to fetch favicon as a simple check
                                    fetch(item.endpoint + '/favicon.ico', { 
                                        method: 'HEAD',
                                        mode: 'no-cors'
                                    }).then(() => resolve(true)).catch(() => resolve(false));
                                };
                                // Try loading favicon which most apps have
                                img.src = item.endpoint + '/favicon.ico?' + Date.now();
                            }),
                            timeout
                        ]);
                        
                        const endTime = performance.now();
                        const responseTime = Math.round(endTime - startTime);
                        
                        // Add data point for charting if auto-refresh is active
                        addDataPoint(item.name, responseTime);
                        
                        return {
                            status: responseTime > 1000 ? 'slow' : 'healthy',
                            responseTime: `${responseTime}ms`
                        };
                    } catch (e) {
                        // All methods failed, service is down
                        addDataPoint(item.name, 0);
                    }
                }
                
                // Add data point even for failed requests (0ms)
                addDataPoint(item.name, 0);
                return { status: 'down', responseTime: '-' };
            }
        }

        // Check web applications
        async function checkWebapps() {
            const grid = document.getElementById('webappsGrid');

            // Initialize cards if not present
            if (grid.children.length === 0) {
                webapps.forEach(webapp => {
                    const card = document.createElement('service-status-card');
                    card.setAttribute('name', webapp.name);
                    card.setAttribute('port', webapp.port);
                    card.setAttribute('status', 'checking');
                    card.setAttribute('response-time', '...');
                    card.setAttribute('framework', webapp.framework);
                    card.setAttribute('url', webapp.url);
                    if (webapp.features) {
                        card.setAttribute('features', JSON.stringify(webapp.features));
                    }
                    card.id = `webapp-${webapp.port}`;
                    grid.appendChild(card);
                });
            }

            // Check all webapps in parallel
            const results = await Promise.all(
                webapps.map(webapp => checkItem(webapp))
            );

            // Update cards with results
            webapps.forEach((webapp, index) => {
                const card = document.getElementById(`webapp-${webapp.port}`);
                const result = results[index];

                card.setAttribute('status', result.status);
                card.setAttribute('response-time', result.responseTime);
                
                // Update chart
                const chartData = getResponseTimeData(webapp.name);
                const canvas = card.shadowRoot?.getElementById(`chart-${webapp.port}`);
                if (canvas) {
                    renderResponseTimeChartOnCanvas(canvas, chartData, webapp.name, result.status);
                }
            });

            // Update stats
            updateWebappStats(results);
        }

        // Check backend services
        async function checkServices() {
            const grid = document.getElementById('servicesGrid');

            // Initialize cards if not present
            if (grid.children.length === 0) {
                services.forEach(service => {
                    const card = document.createElement('service-status-card');
                    card.setAttribute('name', service.name);
                    card.setAttribute('port', service.port);
                    card.setAttribute('status', 'checking');
                    card.setAttribute('response-time', '...');
                    card.setAttribute('language', service.language);
                    card.setAttribute('url', service.url);
                    if (service.features) {
                        card.setAttribute('features', JSON.stringify(service.features));
                    }
                    card.id = `service-${service.port}`;
                    grid.appendChild(card);
                });
            }

            // Check all services in parallel
            const results = await Promise.all(
                services.map(service => checkItem(service))
            );

            // Update cards with results
            services.forEach((service, index) => {
                const card = document.getElementById(`service-${service.port}`);
                const result = results[index];

                card.setAttribute('status', result.status);
                card.setAttribute('response-time', result.responseTime);
                
                // Update chart
                const chartData = getResponseTimeData(service.name);
                const canvas = card.shadowRoot?.getElementById(`chart-${service.port}`);
                if (canvas) {
                    renderResponseTimeChartOnCanvas(canvas, chartData, service.name, result.status);
                }
            });

            // Update stats
            updateServiceStats(results);
        }

        // Update webapp statistics
        function updateWebappStats(results) {
            const healthy = results.filter(r => r.status === 'healthy').length;
            const slow = results.filter(r => r.status === 'slow').length;
            const down = results.filter(r => r.status === 'down').length;

            document.getElementById('webappsHealthyCount').textContent = healthy;
            document.getElementById('webappsSlowCount').textContent = slow;
            document.getElementById('webappsDownCount').textContent = down;
        }

        // Update service statistics
        function updateServiceStats(results) {
            const healthy = results.filter(r => r.status === 'healthy').length;
            const slow = results.filter(r => r.status === 'slow').length;
            const down = results.filter(r => r.status === 'down').length;

            document.getElementById('servicesHealthyCount').textContent = healthy;
            document.getElementById('servicesSlowCount').textContent = slow;
            document.getElementById('servicesDownCount').textContent = down;
        }

        // Check all items
        async function checkAllItems() {
            await Promise.all([
                checkWebapps(),
                checkServices()
            ]);
        }

        // Toggle auto-refresh
        function toggleAutoRefresh() {
            const autoRefreshBtn = document.getElementById('autoRefreshBtn');
            const autoRefreshIcon = document.getElementById('autoRefreshIcon');

            if (autoRefreshInterval) {
                // Stop auto-refresh
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                isAutoRefreshActive = false;
                autoRefreshBtn.classList.remove('active');
                autoRefreshIcon.className = 'fa-solid fa-circle-play';
                
                console.log('Auto-refresh stopped. Data collection paused.');
                console.log('Current response time data:', responseTimeData);
            } else {
                // Start auto-refresh
                isAutoRefreshActive = true;
                initializeDataArrays(); // Initialize data arrays with zeros
                autoRefreshInterval = setInterval(checkAllItems, REFRESH_INTERVAL);
                autoRefreshBtn.classList.add('active');
                autoRefreshIcon.className = 'fa-solid fa-circle-stop';
                checkAllItems();
                
                console.log('Auto-refresh started. Data collection active.');
                console.log('Initialized data arrays:', responseTimeData);
            }
        }

        // Theme management
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            applyTheme(savedTheme);
        }

        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            
            const themeIcon = document.getElementById('themeIcon');
            const themeText = document.getElementById('themeText');
            
            if (theme === 'light') {
                themeIcon.className = 'fa-solid fa-sun';
                themeText.textContent = 'Light';
            } else {
                themeIcon.className = 'fa-solid fa-moon';
                themeText.textContent = 'Dark';
            }
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
            
            // Re-render cards to update theme
            const cards = document.querySelectorAll('service-status-card');
            cards.forEach(card => card.render());
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            initTheme();
            checkAllItems();
        });
    </script>
</body>

</html>
